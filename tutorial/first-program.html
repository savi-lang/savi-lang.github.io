<!doctype html>
<html dir="ltr" lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Savi • A fast language for programmers who are passionate about their craft.</title>

    <meta property="og:title" content="Savi">
    <meta property="og:url" content="https://savi-lang.github.io">
    <meta property="og:description" content="A fast language for programmers who are passionate about their craft.">
    <meta property="og:image" content="https://savi-lang.github.io/assets/logo.png">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@savi-lang">
    <meta name="twitter:creator" content="@savi-lang">
    <meta name="twitter:title" content="Savi">
    <meta name="twitter:description" content="A fast language for programmers who are passionate about their craft.">
    <meta name="twitter:image" content="https://savi-lang.github.io/assets/logo.png">

    <link rel="apple-touch-icon-precomposed" href="/assets/img/apple-touch-icon.png">
    <link rel="icon" type="image/png" href="/assets/img/favicon.png" >

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300&family=Montserrat&display=swap" rel="stylesheet"> -->
    <!-- <link href="https://fonts.googleapis.com/css2?family=Didact+Gothic&family=Montserrat&display=swap" rel="stylesheet"> -->
    <link href="https://fonts.googleapis.com/css2?family=Darker+Grotesque:wght@400&family=Montserrat&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="/assets/css/placement.css">
    <link rel="stylesheet" href="/assets/css/fonts.css">
    <link rel="stylesheet" href="/assets/css/color.css">
    <link rel="stylesheet" href="/assets/css/icon.css">
    <link rel="stylesheet" href="/assets/css/demo.css">
  </head>
  <body>
    <div class="root">
      <div class="row root-top">
  <header class="row section-top section-left">
    <img src="/assets/img/logo.png" height="70px"/>
    <div class="row-remainder"></div>
    <div class="row flex-center" style="margin-right: 5px;">
      <div class="column flex-center">
        <img src="https://simpleicons.org/icons/github.svg"
          height="18px" class="icon-button icon-filter-light"/>
        <img src="https://simpleicons.org/icons/windowsterminal.svg"
          height="18px" class="icon-button icon-filter-light"/>
      </div>
      <div class="column flex-center">
        <img src="https://simpleicons.org/icons/twitter.svg"
          height="18px" class="icon-button icon-filter-light"/>
        <img src="https://simpleicons.org/icons/twitch.svg"
          height="18px" class="icon-button icon-filter-light"/>
      </div>
    </div>
  </header>
  <header class="row section-top section-mid">
    <h1>Your First Program</h1>
  </header>
  <header class="section-top section-right">
  </header>
</div>
<div class="row root-bottom column-remainder">
  <section class="section-bottom section-left">
    
      
    
      
        
          
        
          
            <h1>
              <a href="/tutorial" class="current">
                Tutorial
              </a>
            </h1>
          
        
      
    
      
    
      
    
    
      
    
      
    
      
    
      
        <ul>
          
            <li>
              <a href="/tutorial/first-program" class="current">
                Your First Program
              </a>
            </li>
          
        </ul>
      
    
  </section>
  <div class="column section-main row-remainder">
    <div class="row-reverse">
<div class="section-bottom section-right">
  <div class="content">

<p>Now that we have a Savi compiler installed, it’s time to put it through the paces of building a simple application.</p>

<p>Let’s build an echo server - a TCP listener that simply echoes whatever bytes it receives from its clients back to them.</p>
  </div>
</div>
<div class="section-bottom section-mid">
  <div class="content">
  </div>
</div>
</div>

<div class="row-reverse">
<div class="section-bottom section-right">
  <div class="content">
<hr />


<p>We’ll start by creating a simple git repository. This is not strictly necessary for using Savi, but it’s a good development practice to have somewhere to commit your work incrementally.</p>
  </div>
</div>
<div class="section-bottom section-mid">
  <div class="content">

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git init savi-echo-server
<span class="nb">cd </span>savi-echo-server
git status
</code></pre></div></div>

<pre><code>Initialized empty Git repository in ~/Documents/code/savi/savi-echo-server/.git/
On branch main

No commits yet

nothing to commit (create/copy files and use "git add" to track)
</code></pre>
  </div>
</div>
</div>

<div class="row-reverse">
<div class="section-bottom section-right">
  <div class="content">
<hr />


<p>Now let’s use Savi to initialize a small bit of boilerplate code for a new executable binary, to be named <code>echo-server</code>.</p>
  </div>
</div>
<div class="section-bottom section-mid">
  <div class="content">

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>savi init bin echo-server
</code></pre></div></div>

<pre><code>Creating manifest.savi
Creating src/Main.savi
</code></pre>
  </div>
</div>
</div>

<div class="row-reverse">
<div class="section-bottom section-right">
  <div class="content">
<hr />


<p>Let’s take a look at <code>manifest.savi</code>, which was created to declare the <code>echo-server</code> executable binary and specify where to find the source files for it.</p>
  </div>
</div>
<div class="section-bottom section-mid">
  <div class="content">

<div class="language-savi highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">:manifest</span><span class="w"> </span><span class="kd">bin</span><span class="w"> </span><span class="s2">"echo-server"</span><span class="w">
  </span><span class="nt">:sources</span><span class="w"> </span><span class="s2">"src/*.savi"</span><span class="w">
</span></code></pre></div></div>
  </div>
</div>
</div>

<div class="row-reverse">
<div class="section-bottom section-right">
  <div class="content">
<hr />


<p>And we can look at <code>src/Main.savi</code>, which was created to declare what the <code>Main</code> actor of the program should do.</p>

<p>The <code>Main</code> actor is the entry point of the program. When created, it is given an object of type <code>Env</code> as its constructor argument, giving it the capability to take actions that have side effects.</p>

<p>So far, we only use the <code>Env</code> object to print <code>"Hello, World!"</code>.</p>
  </div>
</div>
<div class="section-bottom section-mid">
  <div class="content">

<div class="language-savi highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">:actor</span><span class="w"> </span><span class="nc">Main</span><span class="w">
  </span><span class="nt">:new</span><span class="w"> </span><span class="p">(</span><span class="n">env</span><span class="w"> </span><span class="nc">Env</span><span class="p">)</span><span class="w">
    </span><span class="n">env</span><span class="p">.</span><span class="nf">out</span><span class="p">.</span><span class="nf">print</span><span class="p">(</span><span class="s2">"Hello, World!"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
  </div>
</div>
</div>

<div class="row-reverse">
<div class="section-bottom section-right">
  <div class="content">
<hr />


<p>Now let’s build it, using the Savi compiler.</p>

<p>There’s only one manifest so far, so we don’t need to specify <code>echo-server</code> explicitly.</p>
  </div>
</div>
<div class="section-bottom section-mid">
  <div class="content">

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>savi build
</code></pre></div></div>
  </div>
</div>
</div>

<div class="row-reverse">
<div class="section-bottom section-right">
  <div class="content">
<hr />


<p>Savi created an executable binary called <code>bin/echo-server</code>, which we can now run.</p>
  </div>
</div>
<div class="section-bottom section-mid">
  <div class="content">

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bin/echo-server
</code></pre></div></div>

<pre><code>Hello, World!
</code></pre>
  </div>
</div>
</div>

<div class="row-reverse">
<div class="section-bottom section-right">
  <div class="content">
<hr />


<p>Great, so now we know that we can build and run a basic program, but it’s not a TCP server yet.</p>

<p>If we look at <a href="https://github.com/savi-lang/library-index/blob/main/all.md">the Savi library index</a>, we see that in the “Standard Library” section there is a library named <code>TCP</code> that probably can do what we want.</p>

<p>So let’s add <code>TCP</code> as a dependency.</p>
  </div>
</div>
<div class="section-bottom section-mid">
  <div class="content">

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>savi deps add TCP
</code></pre></div></div>

<pre><code>Finding a remote location for the TCP library...
Found a known location: github:savi-lang/TCP
Downloading new library versions from GitHub...
Downloaded TCP v0.20220405.0
Downloading new library versions from GitHub...
Downloaded ByteStream v0.20220304.0
Downloaded IO v0.20220405.0
Downloaded OSError v0.20220325.0
Downloaded IPAddress v0.20220404.1
</code></pre>
  </div>
</div>
</div>

<div class="row-reverse">
<div class="section-bottom section-right">
  <div class="content">
<hr />


<p>We also want to add a simple logger that we can easily pass around our application.</p>

<p>So let’s add <code>Logger</code> as a dependency as well.</p>
  </div>
</div>
<div class="section-bottom section-mid">
  <div class="content">

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>savi deps add Logger
</code></pre></div></div>

<pre><code>Finding a remote location for the Logger library...
Found a known location: github:savi-lang/Logger
Downloading new library versions from GitHub...
Downloaded Logger v0.20220401.0
Downloading new library versions from GitHub...
Downloaded Time v0.20220325.0
</code></pre>
  </div>
</div>
</div>

<div class="row-reverse">
<div class="section-bottom section-right">
  <div class="content">
<hr />


<p>If we look again at our <code>manifest.savi</code> file we can see it has been automatically modified by Savi to show the <code>TCP</code> dependency, as well as the transitive dependencies that it depends on (<code>ByteStream</code>, <code>IO</code>, <code>OSError</code>, and <code>IPAddress</code>). Then we see the <code>Logger</code> dependency and its transitive dependency (<code>Time</code>).</p>

<p>In the manifest, Savi shows us where each of these libraries is sourced from and how they depend on one another. When this file is committed to a shared repository along with other source code changes, code reviewers will be able to see the dependency structure and how it changes over time.</p>

<p>Like all other declarative constructs in Savi, each declaration line begins with a <code>:</code>-prefixed keyword that lets the parser know to treat the line as a declaration.</p>

<p>The order of declarations doesn’t matter, and Savi won’t reorder existing declarations in the manifest when changing dependencies, so you can feel free to reorder the declarations in whatever order you think is easiest to audit. You can also add comments - those will be preserved as well. Or just leave it alone and let the Savi compiler manage this file by itself.</p>
  </div>
</div>
<div class="section-bottom section-mid">
  <div class="content">

<div class="language-savi highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">:manifest</span><span class="w"> </span><span class="kd">bin</span><span class="w"> </span><span class="s2">"echo-server"</span><span class="w">
  </span><span class="nt">:sources</span><span class="w"> </span><span class="s2">"src/*.savi"</span><span class="w">

  </span><span class="nt">:dependency</span><span class="w"> </span><span class="nc">TCP</span><span class="w"> </span><span class="kd">v0</span><span class="w">
    </span><span class="nt">:from</span><span class="w"> </span><span class="s2">"github:savi-lang/TCP"</span><span class="w">
    </span><span class="nt">:depends</span><span class="w"> </span><span class="kd">on</span><span class="w"> </span><span class="nc">ByteStream</span><span class="w">
    </span><span class="nt">:depends</span><span class="w"> </span><span class="kd">on</span><span class="w"> </span><span class="nc">IO</span><span class="w">
    </span><span class="nt">:depends</span><span class="w"> </span><span class="kd">on</span><span class="w"> </span><span class="nc">OSError</span><span class="w">
    </span><span class="nt">:depends</span><span class="w"> </span><span class="kd">on</span><span class="w"> </span><span class="nc">IPAddress</span><span class="w">

  </span><span class="nt">:transitive</span><span class="w"> </span><span class="kd">dependency</span><span class="w"> </span><span class="nc">ByteStream</span><span class="w"> </span><span class="kd">v0</span><span class="w">
    </span><span class="nt">:from</span><span class="w"> </span><span class="s2">"github:savi-lang/ByteStream"</span><span class="w">

  </span><span class="nt">:transitive</span><span class="w"> </span><span class="kd">dependency</span><span class="w"> </span><span class="nc">IO</span><span class="w"> </span><span class="kd">v0</span><span class="w">
    </span><span class="nt">:from</span><span class="w"> </span><span class="s2">"github:savi-lang/IO"</span><span class="w">
    </span><span class="nt">:depends</span><span class="w"> </span><span class="kd">on</span><span class="w"> </span><span class="nc">ByteStream</span><span class="w">
    </span><span class="nt">:depends</span><span class="w"> </span><span class="kd">on</span><span class="w"> </span><span class="nc">OSError</span><span class="w">

  </span><span class="nt">:transitive</span><span class="w"> </span><span class="kd">dependency</span><span class="w"> </span><span class="nc">OSError</span><span class="w"> </span><span class="kd">v0</span><span class="w">
    </span><span class="nt">:from</span><span class="w"> </span><span class="s2">"github:savi-lang/OSError"</span><span class="w">

  </span><span class="nt">:transitive</span><span class="w"> </span><span class="kd">dependency</span><span class="w"> </span><span class="nc">IPAddress</span><span class="w"> </span><span class="kd">v0</span><span class="w">
    </span><span class="nt">:from</span><span class="w"> </span><span class="s2">"github:savi-lang/IPAddress"</span><span class="w">

  </span><span class="nt">:dependency</span><span class="w"> </span><span class="nc">Logger</span><span class="w"> </span><span class="kd">v0</span><span class="w">
    </span><span class="nt">:from</span><span class="w"> </span><span class="s2">"github:savi-lang/Logger"</span><span class="w">
    </span><span class="nt">:depends</span><span class="w"> </span><span class="kd">on</span><span class="w"> </span><span class="nc">Time</span><span class="w">

  </span><span class="nt">:transitive</span><span class="w"> </span><span class="kd">dependency</span><span class="w"> </span><span class="nc">Time</span><span class="w"> </span><span class="kd">v0</span><span class="w">
    </span><span class="nt">:from</span><span class="w"> </span><span class="s2">"github:savi-lang/Time"</span><span class="w">
</span></code></pre></div></div>
  </div>
</div>
</div>

<div class="row-reverse">
<div class="section-bottom section-right">
  <div class="content">
<hr />


<p>We notice that the <code>Logger</code> library suggests creating a type alias with the preferred formatter module declared for our project. So let’s do that first.</p>

<p>Create a new file named <code>src/_Log.savi</code> and put the <code>:alias</code> declaration there.</p>

<p>In truth, it doesn’t matter what you name the file (we never need to refer to specific files by name in Savi) as long as it matches the <code>src/*.savi</code> pattern that was set up in the manifest. But by convention we name the file with the name of the type declared within it, adding the <code>.savi</code> filename suffix, making it easy to find things.</p>
  </div>
</div>
<div class="section-bottom section-mid">
  <div class="content">

<div class="language-savi highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">:alias</span><span class="w"> </span><span class="kd">_Log</span><span class="p">:</span><span class="w"> </span><span class="nc">Logger</span><span class="p">(</span><span class="w">
  </span><span class="nc">Logger</span><span class="p">.</span><span class="nc">Formatter</span><span class="p">.</span><span class="nc">StringWithLevelAndTimestamp</span><span class="w">
</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
  </div>
</div>
</div>

<div class="row-reverse">
<div class="section-bottom section-right">
  <div class="content">
<hr />


<p>Now let’s implement our echo server!</p>

<p>In a file named <code>src/EchoServer.savi</code>, we declare an actor named <code>EchoServer</code> that uses the <code>IO.Actor</code> trait and a <code>TCP.Engine</code> field to act as a TCP connection actor. It also holds a <code>_Log</code> instance so it can log messages.</p>

<p>The constructor takes two arguments: a <code>_Log</code> instance (written directly into the <code>log</code> field), as well a “ticket” that represents a pending TCP connection waiting to be accepted (which is used to set up the <code>io</code> field). It’s always required to initialize all fields before the constructor is finished.</p>

<p>The actor reacts to <code>IO.Action.Read</code> by reading all available bytes from the <code>@io.read_stream</code> and sending them to the <code>@io.write_stream</code> (as well as logging them, if the logger is configured to show debug logs). This is the echo behavior of our echo server.</p>
  </div>
</div>
<div class="section-bottom section-mid">
  <div class="content">

<div class="language-savi highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">:actor</span><span class="w"> </span><span class="nc">EchoServer</span><span class="w">
  </span><span class="nt">:is</span><span class="w"> </span><span class="nc">IO</span><span class="p">.</span><span class="nc">Actor</span><span class="p">(</span><span class="nc">IO</span><span class="p">.</span><span class="nc">Action</span><span class="p">)</span><span class="w">
  </span><span class="nt">:let</span><span class="w"> </span><span class="kd">log</span><span class="w"> </span><span class="kd">_Log</span><span class="w">
  </span><span class="nt">:let</span><span class="w"> </span><span class="kd">io</span><span class="w"> </span><span class="nc">TCP</span><span class="p">.</span><span class="nc">Engine</span><span class="w">

  </span><span class="nt">:new</span><span class="w"> </span><span class="p">(@</span><span class="nf">log</span><span class="p">,</span><span class="w"> </span><span class="n">ticket</span><span class="p">)</span><span class="w">
    </span><span class="p">@</span><span class="nf">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">TCP</span><span class="p">.</span><span class="nc">Engine</span><span class="p">.</span><span class="nf">accept</span><span class="p">(@,</span><span class="w"> </span><span class="o">--</span><span class="n">ticket</span><span class="p">)</span><span class="w">
    </span><span class="p">@</span><span class="nf">log</span><span class="p">.</span><span class="nf">info</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="s2">"Accepted connection"</span><span class="p">)</span><span class="w">

  </span><span class="nt">:fun</span><span class="w"> </span><span class="kd">ref</span><span class="w"> </span><span class="kd">io_react</span><span class="p">(</span><span class="n">action</span><span class="w"> </span><span class="nc">IO</span><span class="p">.</span><span class="nc">Action</span><span class="p">)</span><span class="w">
    </span><span class="n">case</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">(</span><span class="w">
    </span><span class="o">|</span><span class="w"> </span><span class="nc">IO</span><span class="p">.</span><span class="nc">Action</span><span class="p">.</span><span class="nc">Read</span><span class="w"> </span><span class="o">|</span><span class="w">
      </span><span class="p">@</span><span class="nf">io</span><span class="p">.</span><span class="nf">pending_reads</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="w">
        </span><span class="n">bytes</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w">
          </span><span class="p">@</span><span class="nf">io</span><span class="p">.</span><span class="nf">read_stream</span><span class="p">.</span><span class="nf">extract_all</span><span class="w">

        </span><span class="p">@</span><span class="nf">io</span><span class="p">.</span><span class="nf">write_stream</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">bytes</span><span class="w">
        </span><span class="n">try</span><span class="w"> </span><span class="p">@</span><span class="nf">io</span><span class="p">.</span><span class="nf">flush</span><span class="o">!</span><span class="w">

        </span><span class="p">@</span><span class="nf">log</span><span class="p">.</span><span class="nf">debug</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="w">
          </span><span class="s2">"Echoed: </span><span class="si">\(</span><span class="nc">Inspect</span><span class="p">[</span><span class="n">bytes</span><span class="p">]</span><span class="si">)</span><span class="s2">"</span><span class="w">
        </span><span class="p">)</span><span class="w">
      </span><span class="p">)</span><span class="w">
    </span><span class="o">|</span><span class="w"> </span><span class="nc">IO</span><span class="p">.</span><span class="nc">Action</span><span class="p">.</span><span class="nc">Closed</span><span class="w"> </span><span class="o">|</span><span class="w">
      </span><span class="p">@</span><span class="nf">log</span><span class="p">.</span><span class="nf">info</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="s2">"Closed connection"</span><span class="p">)</span><span class="w">
    </span><span class="p">)</span><span class="w">
    </span><span class="p">@</span><span class="w">
</span></code></pre></div></div>
  </div>
</div>
</div>

<div class="row-reverse">
<div class="section-bottom section-right">
  <div class="content">
<hr />


<p>If we try to compile this program now with <code>savi build</code> we see an error telling us it couldn’t find the <code>IO.Actor</code> type, which may seem strange, because we saw earlier that the <code>IO</code> library is already in our manifest.</p>
  </div>
</div>
<div class="section-bottom section-mid">
  <div class="content">

<pre><code>This type couldn't be resolved:
from ./src/Main.savi:15:
  :is IO.Actor(IO.Action) // TODO: remove type argument?
      ^~~~~~~~~~~~~~~~~~~
</code></pre>
  </div>
</div>
</div>

<div class="row-reverse">
<div class="section-bottom section-right">
  <div class="content">
<hr />


<p>However, we note that it’s currently there as a <em>transitive</em> dependency. Only direct dependencies will be in scope for type resolution, so if we want to use the <code>IO</code> type we need to load it in as a direct dependency.</p>

<p>After this, our code should compile successfully again.</p>
  </div>
</div>
<div class="section-bottom section-mid">
  <div class="content">

<pre><code>savi deps add IO
</code></pre>
  </div>
</div>
</div>

<div class="row-reverse">
<div class="section-bottom section-right">
  <div class="content">
<hr />


<p>Now that we have an actor that can handle echoing on a TCP connection, we need a TCP listener actor that can listen for new TCP connections.</p>

<p>Let’s create <code>src/EchoServer.Listener.savi</code> with a new <code>EchoServer.Listener</code> actor.</p>

<p>It is also an <code>IO.Actor</code>, and it takes a logger and a ticket, but it uses <code>TCP.Listen.Engine</code> instead of <code>TCP.Engine</code> for its <code>io</code> field, which means that it deals with IO actions differently.</p>

<p>When it’s begun listening (on <code>IO.Action.Opened</code>), our actor will log its port number. For every new pending connection (on <code>IO.Action.Read</code>), it creates a new <code>EchoServer</code> actor to accept and manage the connection, by passing the ticket for the connection to that actor.</p>
  </div>
</div>
<div class="section-bottom section-mid">
  <div class="content">

<div class="language-savi highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">:actor</span><span class="w"> </span><span class="nc">EchoServer</span><span class="p">.</span><span class="nc">Listener</span><span class="w">
  </span><span class="nt">:is</span><span class="w"> </span><span class="nc">IO</span><span class="p">.</span><span class="nc">Actor</span><span class="p">(</span><span class="nc">IO</span><span class="p">.</span><span class="nc">Action</span><span class="p">)</span><span class="w">
  </span><span class="nt">:let</span><span class="w"> </span><span class="kd">log</span><span class="w"> </span><span class="kd">_Log</span><span class="w">
  </span><span class="nt">:let</span><span class="w"> </span><span class="kd">io</span><span class="w"> </span><span class="nc">TCP</span><span class="p">.</span><span class="nc">Listen</span><span class="p">.</span><span class="nc">Engine</span><span class="w">

  </span><span class="nt">:new</span><span class="w"> </span><span class="p">(@</span><span class="nf">log</span><span class="p">,</span><span class="w"> </span><span class="n">ticket</span><span class="p">)</span><span class="w">
    </span><span class="p">@</span><span class="nf">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">TCP</span><span class="p">.</span><span class="nc">Listen</span><span class="p">.</span><span class="nc">Engine</span><span class="p">.</span><span class="nf">new</span><span class="p">(@,</span><span class="w"> </span><span class="o">--</span><span class="n">ticket</span><span class="p">)</span><span class="w">

  </span><span class="nt">:fun</span><span class="w"> </span><span class="kd">ref</span><span class="w"> </span><span class="kd">io_react</span><span class="p">(</span><span class="n">action</span><span class="w"> </span><span class="nc">IO</span><span class="p">.</span><span class="nc">Action</span><span class="p">)</span><span class="w">
    </span><span class="n">case</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">(</span><span class="w">
    </span><span class="o">|</span><span class="w"> </span><span class="nc">IO</span><span class="p">.</span><span class="nc">Action</span><span class="p">.</span><span class="nc">Opened</span><span class="w"> </span><span class="o">|</span><span class="w">
      </span><span class="p">@</span><span class="nf">log</span><span class="p">.</span><span class="nf">info</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="w">
        </span><span class="n">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">try</span><span class="w"> </span><span class="p">@</span><span class="nf">io</span><span class="p">.</span><span class="nf">listen_port_number</span><span class="o">!</span><span class="w">
        </span><span class="s2">"Listening on port: </span><span class="si">\(</span><span class="n">port</span><span class="si">)</span><span class="s2">"</span><span class="w">
      </span><span class="p">)</span><span class="w">
    </span><span class="o">|</span><span class="w"> </span><span class="nc">IO</span><span class="p">.</span><span class="nc">Action</span><span class="p">.</span><span class="nc">OpenFailed</span><span class="w"> </span><span class="o">|</span><span class="w">
      </span><span class="p">@</span><span class="nf">log</span><span class="p">.</span><span class="nf">error</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="w">
        </span><span class="s2">"Failed to listen: </span><span class="si">\(</span><span class="p">@</span><span class="nf">io</span><span class="p">.</span><span class="nf">listen_error</span><span class="si">)</span><span class="s2">"</span><span class="w">
      </span><span class="p">)</span><span class="w">
    </span><span class="o">|</span><span class="w"> </span><span class="nc">IO</span><span class="p">.</span><span class="nc">Action</span><span class="p">.</span><span class="nc">Read</span><span class="w"> </span><span class="o">|</span><span class="w">
      </span><span class="p">@</span><span class="nf">io</span><span class="p">.</span><span class="nf">pending_connections</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">ticket</span><span class="w"> </span><span class="o">|</span><span class="w">
        </span><span class="nc">EchoServer</span><span class="p">.</span><span class="nf">new</span><span class="p">(@</span><span class="nf">log</span><span class="p">,</span><span class="w"> </span><span class="o">--</span><span class="n">ticket</span><span class="p">)</span><span class="w">
      </span><span class="p">)</span><span class="w">
    </span><span class="o">|</span><span class="w"> </span><span class="nc">IO</span><span class="p">.</span><span class="nc">Action</span><span class="p">.</span><span class="nc">Closed</span><span class="w"> </span><span class="o">|</span><span class="w">
      </span><span class="p">@</span><span class="nf">log</span><span class="p">.</span><span class="nf">info</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="s2">"Stopped listening"</span><span class="p">)</span><span class="w">
    </span><span class="p">)</span><span class="w">
    </span><span class="p">@</span><span class="w">
</span></code></pre></div></div>
  </div>
</div>
</div>

<div class="row-reverse">
<div class="section-bottom section-right">
  <div class="content">
<hr />


<p>That’s pretty much it!</p>

<p>The last step is to hook into the main entrypoint of the program in <code>src/Main.savi</code> so that it creates the listener (instead of just printing “Hello, World!” as it does now).</p>

<p>Our <code>Main</code> actor is responsible for kicking off the program and delegating the right amount of authority to the actors in it. By holding the <code>Env</code> it has the authority to do anything, but it can (and should) attenuate that authority according to the principle of least privilege.</p>

<p>In this case, we use the <code>env</code> to create a <code>_Log</code> instance that can log to standard error output (<code>env.err</code>), and we create a TCP listen ticket that can listen on a particular host and port.</p>

<p>In this example, the <code>host</code> is hard-coded and the <code>port</code> is taken from the first CLI argument (if present). The CLI user may specify a number (such as <code>80</code>) or a name (such as <code>http</code>) or leave the argument so that the program uses the default empty string, which allows the listener to choose any arbitrary open port.</p>
  </div>
</div>
<div class="section-bottom section-mid">
  <div class="content">

<div class="language-savi highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">:actor</span><span class="w"> </span><span class="nc">Main</span><span class="w">
  </span><span class="nt">:new</span><span class="w"> </span><span class="p">(</span><span class="n">env</span><span class="w"> </span><span class="nc">Env</span><span class="p">)</span><span class="w">
    </span><span class="n">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"0.0.0.0"</span><span class="w">
    </span><span class="n">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">try</span><span class="w"> </span><span class="p">(</span><span class="n">env</span><span class="p">.</span><span class="nf">args</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="gd">!</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s2">""</span><span class="p">)</span><span class="w">
    </span><span class="nc">EchoServer</span><span class="p">.</span><span class="nc">Listener</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="w">
      </span><span class="nc">_Log</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">env</span><span class="p">.</span><span class="nf">err</span><span class="p">,</span><span class="w"> </span><span class="nc">Logger</span><span class="p">.</span><span class="nc">Level</span><span class="p">.</span><span class="nc">Debug</span><span class="p">)</span><span class="w">
      </span><span class="nc">TCP</span><span class="p">.</span><span class="nf">auth</span><span class="p">(</span><span class="n">env</span><span class="p">.</span><span class="nf">root</span><span class="p">).</span><span class="nf">listen</span><span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="w"> </span><span class="n">port</span><span class="p">)</span><span class="w">
    </span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
  </div>
</div>
</div>

<div class="row-reverse">
<div class="section-bottom section-right">
  <div class="content">
<hr />


<p>Now we can build and run again, specifying a particular listen port if we wish.</p>

<p>We’ll see it log when it’s started listening.</p>
  </div>
</div>
<div class="section-bottom section-mid">
  <div class="content">

<pre><code>savi build
bin/echo-server 50512
</code></pre>

<pre><code>INFO  2022-04-12 16:03:47.549 | Listening on port: 50512
</code></pre>
  </div>
</div>
</div>

<div class="row-reverse">
<div class="section-bottom section-right">
  <div class="content">
<hr />


<p>We can connect to our echo server with the <code>telnet</code> command in a separate terminal.</p>
  </div>
</div>
<div class="section-bottom section-mid">
  <div class="content">

<pre><code>telnet localhost 50512
</code></pre>

<pre><code>Trying ::1...
Trying 127.0.0.1...
Connected to localhost.
Escape character is '^]'.
</code></pre>
  </div>
</div>
</div>

<div class="row-reverse">
<div class="section-bottom section-right">
  <div class="content">
<hr />


<p>Once connected, if we type something in the <code>telnet</code> terminal we’ll see it echoed back to us, and we’ll also see it logged in the server as debug-level log messages.</p>
  </div>
</div>
<div class="section-bottom section-mid">
  <div class="content">

<pre><code>Hello, World!
Hello, World!
</code></pre>

<pre><code>INFO  2022-04-12 16:06:47.505 | Accepted connection
DEBUG 2022-04-12 16:08:39.455 | Echoed: b"Hello, World!\r\n"
</code></pre>
  </div>
</div>
</div>

<div class="row-reverse">
<div class="section-bottom section-right">
  <div class="content">
<hr />


<p>That’s it for this tutorial!</p>

<p>If you enjoyed this, please consider committing the source code as a public repository on GitHub. It will help us get GitHub to recognize our language and enable syntax highlighting (they require a threshold number of repositories before they will allow our language to be detected).</p>
  </div>
</div>
<div class="section-bottom section-mid">
  <div class="content">
  </div>
</div>
</div>


    <div class="row row-remainder">
      <div class="section-bottom section-mid"></div>
      <div class="section-bottom section-right"></div>
    </div>
  </div>
</div>

    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/12.1.0/markdown-it.min.js" integrity="sha512-PKP2kuWuLFN4vcsGg5MQI/Z7AzGsQZGiVCpmchDik0hWie1MCx1k+lGn7YJNoU77NyufcFi2ra21exAdEIIXNQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha512-z4OUqw38qNLpn1libAN9BsoDx6nbNFio5lA6CuTp9NlK83b89hgyCVq+N5FdBJptINztxn1Z3SaKSKUS5UP60Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="/assets/js/demo.js"></script>
    <script src="/assets/js/markdown.js"></script>
  </body>
</html>
